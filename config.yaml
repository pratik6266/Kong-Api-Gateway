_format_version: "1.1"

services:
  - name: echo-server
    url: http://golang-server:8080
    # host: golang-upstream         # <-- use the upstream by name
    # protocol: http
    # port: 80
    routes:
      - name: echo
        paths: ["/api/v1"]
        strip_path: false

  - name: echo-server2
    url: http://golang-server2:3000
    routes:
      - name: echo2
        paths: ["/api/v2"]
        strip_path: false

consumers:
  - username: user

basicauth_credentials:
  - username: user
    password: password123
    consumer: user

upstreams:
  - name: golang-upstream
    # default algorithm is round-robin
    targets:
      - target: golang-server:8080
        weight: 100
      - target: golang-server2:3000
        weight: 50

# âœ… Correct collection name for API key credentials
keyauth_credentials:
  - key: my-secret-key
    consumer: user

plugins:
  - name: cors
    config:
      origins: ["*"]
      methods: [GET, POST, OPTIONS, PUT, DELETE]
      headers: [Accept, Authorization, Content-Type, X-Requested-With]
      exposed_headers: [X-My-Custom-Header]
      max_age: 3600
      preflight_continue: false

  - name: rate-limiting
    service: echo-server
    config:
      minute: 5
      policy: local

  - name: ip-restriction
    config:
      deny:
        - "192.168.1.27"

  - name: proxy-cache
    service: echo-server
    config:
      strategy: memory
      response_code: [200, 301, 404]
      request_method: [GET, HEAD]
      content_type:
        - application/json; charset=utf-8
        - application/json
        - text/plain
      cache_ttl: 300
      cache_control: true
      response_headers:
        X-Cache-Key: true
        X-Cache-Status: true
        age: true

  - name: basic-auth
    service: echo-server
    config:
      hide_credentials: true

  - name: key-auth
    service: echo-server2
    config:
      key_names: ["apikey"]   
      hide_credentials: true

  - name: request-termination # allows you to terminate requests based on specific conditions
    service: echo-server2
    config:
      status_code: 403
      message: "Access to this service is forbidden."

  - name: request-size-limiting # restricts the size of incoming requests
    service: echo-server
    config: 
      allowed_payload_size: 1 # in bytes  

  - name: file-log # logs requests and responses to a specified file
    config: 
      path: "/dev/stdout"
      reopen: false

  - name: prometheus
    config:
      status_code_metrics: true

  # - name: rate-limiting-advanced
  #   service: echo-server
  #   config:
  #     minute: 10
  #     policy: local

  